---
title: "Analysis for reward vs no reward pollen choice experiments"
output: html_notebook
editor_options: 
  chunk_output_type: console
---



```{r, setup}
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if(length(new.pkg)) install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}
  
packages <- c("ggplot2", "car", "plyr", "tidyr")
ipak(packages)



# dataDir = "D:/Dropbox/UW/ExperWinter2018/BeeTwoFlowerChoiceData/"
# figDir = "D:/Dropbox/UW/ExperWinter2018/BeeTwoFLowerChoiceFigures/"

dataDir = "/Users/cswitzer/Dropbox/UW/ExperWinter2018/BeeTwoFlowerChoiceData"
figDir= "/Users/cswitzer/Dropbox/UW/ExperWinter2018/BeeTwoFlowerChoiceFigures"



```



```{r}
# load in data
csvList = list.files(dataDir)


for (ii in csvList){
 
  
   tmp = read.csv(file.path(dataDir, ii), stringsAsFactors = FALSE)
  
   tmp$ID = ii
   
   if(ii == csvList[1]) newDF = tmp
   else newDF = rbind(tmp, newDF)
}  

```


```{r}
newDF$rewardStatus = tolower(newDF$rewardStatus)

unique(newDF$rewardStatus)


summaryDF = as.data.frame(xtabs(~newDF$ID + newDF$rewardStatus + newDF$accNum))

summaryDF

# convert to wide format


summary_wide = spread(summaryDF,   newDF.accNum, Freq)
summary_wide2 = spread(summaryDF,   newDF.rewardStatus, Freq)

# insert treatment
summary_wide$treatment = sapply(summary_wide$newDF.ID, FUN = function(x) newDF[newDF$ID == x, "treatment"][1])


summary_wide

# remove rows where both rewarded the bee
summary_wide = summary_wide[summary_wide$treatment != "Dev2/ai0_True__Dev2/ai1_True", ]
summary_wide

# make sure at one column is 0
summary_wide$`Dev2/ai0` ==0 | summary_wide$`Dev2/ai1` == 0

# combine to make a visit column
summary_wide$visits = summary_wide$`Dev2/ai0` + summary_wide$`Dev2/ai1`

# make wide
sw3 = spread(summary_wide[, c("newDF.ID", "newDF.rewardStatus", "visits", "treatment")],   newDF.rewardStatus, visits)
sw3

# refref: add hive humber
sw3$colonyNum = sapply(sw3$newDF.ID, FUN = function(x) newDF[newDF$ID == x, "colonyNum"][1])
sw3$IT = sapply(sw3$newDF.ID, FUN = function(x) newDF[newDF$ID == x, "ITSpan_mm"][1])


# now we're ready for binomial regression
sw3$prop = sw3$true / (sw3$true + sw3$false)
write.csv(sw3, file = file.path(figDir, "prelimData.csv"))



ggplot(sw3, aes(x = newDF.ID, y = prop)) + 
  geom_bar(stat = "identity") + 
  geom_hline(aes(yintercept = 0.5), lty = 2) + 
  theme_classic()
  
```


## GLM

```{r}
library(lme4)
sw4 <- sw3


m1 <- glmer(cbind(true, false)~ (1|`newDF.ID`), family = binomial("logit"), data = sw4)
summary(m1)

# evaluate fit
library("blmeco") 
dispersion_glmer(m1) #if the scale paramter is between 0.75 and 1.4, there may not be an overdispersion problem.

qqnorm(ranef(m1)$`newDF.ID`[,1])
qqline(ranef(m1)$`newDF.ID`[,1])

plot(fitted(m1), resid(m1)) #residuals vs fitted
abline(h=0)

# bad at predicting low and high
sw4$fitted <- predict(m1, type = "response") #fitted vs observed
plot(sw4$fitted, sw4$prop)
abline(0,1)


pframe <- data.frame(`newDF.ID` = 99999)
pframe$prob <- 0
pp <- predict(m1, newdata = pframe, re.form=NA, type = 'response') # re.form sets all random effects to 0

bm = bootMer(m1, FUN=function(x){
                        predict(x, 
                                pframe, 
                                re.form=NA, 
                                type = 'response')
                        }, 
             nsim = 1000)

bb2_se <-apply(bm$t,2,function(x) quantile(x, probs = c(0.025, 0.975)))
pframe$blo<-bb2_se[1,]
pframe$bhi<-bb2_se[2,]
pframe$predMean <- pp
pframe <- pframe[, c("blo", "bhi", "predMean")]
pframe


ggplot(pframe, aes(x = 1, y = predMean)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = blo, ymax = bhi), width = 0.1)  + 
  theme_classic() + 
  xlim(0.5,1.5) + 
  xlab("") + 
  ylab("predicted proportion of visits to rewarding flower") + 
  ylim(0,1) + 
  geom_hline(aes(yintercept = 0.5), lty = 2, col = 'red') + 
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.line.x = element_blank())

ggsave(file.path(figDir, "propSuccessPollen_8Feb.pdf"), width = 2, height = 4)

colSums(sw3[, 3:4])[2] / sum(colSums(sw3[, 3:4]))


# diagnostics
plot(m1)

plot(ranef(m1))

```
